<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Meine Bahnstrecken Karte</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html, body { height: 100%; margin: 0 }
    #map { position: absolute; inset: 0 }
    .home-btn {
      position: absolute; top: 12px; left: 60px;
      background: #fff; border: 1px solid rgba(0,0,0,.15); border-radius: 8px;
      padding: 8px 12px; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #111; text-decoration: none;
    }
    .home-btn:hover { background: #f6f6f6 }
    .panel {
      position: absolute; top: 12px; right: 12px;
      background: #fff; border: 1px solid rgba(0,0,0,.15); border-radius: 8px;
      padding: 8px 10px; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
    }
    .panel h3 { margin: 0 0 6px 0; font-size: 14px }
    .row { display: flex; align-items: center; gap: 8px; margin: 6px 0 }
    .attribution { position: absolute; left: 12px; bottom: 12px; background: rgba(255,255,255,.9); padding: 4px 6px; border-radius: 6px; font-size: 12px }
  </style>
</head>
<body>
  <div id="map"></div>

  <a class="home-btn" href="index.html" role="button">Home</a>

  <div class="panel" id="ui">
    <h3>Kartenebenen</h3>
    <div class="row">
      <label><input type="checkbox" id="toggle-orm"> OpenRailwayMap</label>
    </div>
  </div>

  <div class="attribution">
    Daten: © OpenStreetMap Mitwirkende. Gleis-Overlay: © OpenRailwayMap
  </div>

  <script>
    // Eigener Mapbox Token hier eintragen
    mapboxgl.accessToken = "pk.eyJ1Ijoibmljb3J1Z2UiLCJhIjoiY21nODVoZ2R2MDNqOTJqczg3c3F4cmZ3MiJ9.1fgkuGwAxjLf26gtzgOm0w";

    // Karte initialisieren (Style je nach gewähltem Theme aus index.html)
    const savedTheme = (localStorage.getItem('theme') || 'dark');
    try { document.documentElement.setAttribute('data-theme', savedTheme); } catch (_) {}
    const baseStyle = savedTheme === 'dark'
      ? 'mapbox://styles/mapbox/dark-v11'
      : 'mapbox://styles/mapbox/streets-v12';

    const map = new mapboxgl.Map({
      container: "map",
      style: baseStyle,
      center: [9.0, 50.5],
      zoom: 6,
      pitch: 0,
      bearing: 0
    });

    // Standard-Controls
    map.addControl(new mapboxgl.NavigationControl(), "top-left");
    map.addControl(new mapboxgl.FullscreenControl(), "top-left");
    map.addControl(new mapboxgl.ScaleControl({ unit: "metric" }), "bottom-left");

    // Optionales OpenRailwayMap Overlay als Raster-Layer
    map.on("load", () => {
      // Hide base-map road layers (keep rail-related layers visible)
      const hideRoadLayers = () => {
        const style = map.getStyle();
        if (!style || !style.layers) return;
        for (const layer of style.layers) {
          const id = layer.id || "";
          const srcLayer = layer["source-layer"] || "";
          const filterText = JSON.stringify(layer.filter || "");
          const isRoadishId = id.startsWith("road-") || id.startsWith("bridge-") || id.startsWith("tunnel-") || id === "road-label";
          const isRoadSource = srcLayer === "road" || srcLayer === "road_label";
          const isRailRelated = /\b(rail|tram|subway|light_rail)\b/i.test(id) || /"rail"|"tram"|"subway"|"light_rail"/.test(filterText);
          // detect admin-0 (country) and admin-1 (state/province) boundary line layers
          const isAdminSource = srcLayer === "admin";
          const isBoundaryId = /boundary/i.test(id);
          const adminLevelIdMatch = /(^|-)admin-(0|1)(-|$)/i.test(id);
          const adminLevelFilter01 = /admin\s*[_-]?level\W*(0|1)/i.test(filterText);
          const adminKeyword = /\b(country|state|province|admin-0|admin-1)\b/i.test(id);
          const isAdmin01Boundary = (isBoundaryId && (adminLevelIdMatch || adminLevelFilter01 || adminKeyword)) ||
                                     (isAdminSource && (adminLevelFilter01 || adminKeyword));

          if (((isRoadishId || isRoadSource) && !isRailRelated) || (isAdmin01Boundary && layer.type !== "symbol")) {
            try {
              if (map.getLayer(id)) {
                map.setLayoutProperty(id, "visibility", "none");
              }
            } catch (_) { /* ignore non-toggleable layers */ }
          }
        }
      };
      hideRoadLayers();

      map.addSource("open-railway-map", {
        type: "raster",
        tiles: ["https://a.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png"],
        tileSize: 256,
        attribution: "© OpenRailwayMap"
      });

      map.addLayer({
        id: "open-railway-map",
        type: "raster",
        source: "open-railway-map",
        layout: { visibility: "none" },
        paint: { "raster-opacity": 0.5 }
      });

      // Externe GeoJSONs laden und zusammenführen
const sources = [
  ["nationalExpress","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/nationalExpress.geojson"],
  ["national","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/national.geojson"],
  ["regionalExp","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/regionalExp.geojson"],
  ["regional","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/regional.geojson"],
  ["suburban","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/suburban.geojson"],
  ["subway","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/subway.geojson"],
  ["tram","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/tram.geojson"],
  ["bus","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/bus.geojson"],
  ["ferry","https://raw.githubusercontent.com/Fabian-C/Traewelling_uMap_SRC/main/Lord_NicolasX/ferry.geojson"]
];

Promise.all(sources.map(async ([cat,url]) => {
  const r = await fetch(url);
  const j = await r.json();
  j.features.forEach((f,i) => {
    f.properties = { category: cat, ...(f.properties||{}) };
    if (!f.properties.id) f.properties.id = `${cat}-${i}`;
  });
  return j.features;
}))
.then(all => {
  const merged = { type: "FeatureCollection", features: all.flat() };

  map.addSource("trips", { type: "geojson", data: merged });

  map.addLayer({
    id: "trips-lines",
    type: "line",
    source: "trips",
    layout: { "line-cap": "round", "line-join": "round" },
    paint: {
      "line-color": [
        "match", ["get","category"],
        "nationalExpress","#0073ff",
        "national","#00eeff",
        "regionalExp","#d1024e",
        "regional","#a6026c",
        "suburban","#fc0000",
        "subway","#F69A00",
        "tram","#2FC5CC",
        "bus","#238443",
        "ferry","#800",
        "#333333"
      ],
      "line-width": ["interpolate",["linear"],["zoom"],6,2.5,14,8],
      "line-opacity": 0.95
    }
  });

  // auf Bounds zoomen
  const bounds = new mapboxgl.LngLatBounds();
  merged.features.forEach(f => {
    if (f.geometry?.type === "LineString") {
      f.geometry.coordinates.forEach(c => bounds.extend(c));
    }
  });
  if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 24, maxZoom: 7 });
})
.catch(e => console.warn("Fehler beim Laden der externen GeoJSONs:", e));

      // UI Toggle
      const ormToggle = document.getElementById("toggle-orm");
      ormToggle.addEventListener("change", () => {
        const visible = ormToggle.checked ? "visible" : "none";
        map.setLayoutProperty("open-railway-map", "visibility", visible);
      });
    });

    // Hilfsfunktion: Sobald Streckendaten da sind, kannst du die Bounds anpassen
    // Beispiel:
    // const bounds = new mapboxgl.LngLatBounds();
    // geojson.features.forEach(f => f.geometry.coordinates.forEach(c => bounds.extend(c)));
    // map.fitBounds(bounds, { padding: 24, maxZoom: 10 });
  </script>
</body>
</html>
