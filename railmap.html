<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Meine Bahnstrecken Karte</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html,
    body {
      height: 100%;
      margin: 0
    }

    #map {
      position: absolute;
      inset: 0
    }

    .home-btn {
      position: absolute;
      top: 12px;
      left: 60px;
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .15);
      border-radius: 8px;
      padding: 8px 12px;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #111;
      text-decoration: none;
    }

    .home-btn:hover {
      background: #f6f6f6
    }

    .panel {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .15);
      border-radius: 8px;
      padding: 8px 10px;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
    }

    .panel h3 {
      margin: 0 0 6px 0;
      font-size: 14px
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0
    }

    .attribution {
      position: absolute;
      left: 12px;
      bottom: 12px;
      background: rgba(255, 255, 255, .9);
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 12px
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <a class="home-btn" href="index.html" role="button">Home</a>

  <div class="panel" id="ui">
    <h3>Verkehrsmittel</h3>
    <div class="row"><label><input type="checkbox" class="filter-cb" value="nationalExpress,national" checked>
        National Express</label></div>
    <div class="row"><label><input type="checkbox" class="filter-cb" value="regionalExp,regional" checked>
        Regional Express</label></div>
    <div class="row"><label><input type="checkbox" class="filter-cb" value="suburban" checked> Suburban</label></div>
    <div class="row"><label><input type="checkbox" class="filter-cb" value="subway" checked> Subway</label></div>
    <div class="row"><label><input type="checkbox" class="filter-cb" value="tram" unchecked> Tram</label></div>
    <div class="row"><label><input type="checkbox" class="filter-cb" value="bus" unchecked> Bus</label></div>
    <div class="row"><label><input type="checkbox" class="filter-cb" value="ferry" unchecked> Ferry</label></div>
  </div>

  <script>
    // Eigener Mapbox Token hier eintragen
    mapboxgl.accessToken = "pk.eyJ1Ijoibmljb3J1Z2UiLCJhIjoiY21nODVoZ2R2MDNqOTJqczg3c3F4cmZ3MiJ9.1fgkuGwAxjLf26gtzgOm0w";

    // Karte initialisieren (Style je nach gewähltem Theme aus index.html)
    const savedTheme = (localStorage.getItem('theme') || 'dark');
    try { document.documentElement.setAttribute('data-theme', savedTheme); } catch (_) { }

    const styles = {
      dark: 'mapbox://styles/mapbox/dark-v11',
      light: 'mapbox://styles/mapbox/streets-v12',
      satellite: 'mapbox://styles/mapbox/satellite-streets-v12'
    };

    // Set initial style based on saved theme or default to dark
    const initialStyleKey = savedTheme === 'dark' ? 'dark' : 'light';

    // Listen for theme changes from parent
    window.addEventListener('message', (event) => {
      if (event.data.type === 'theme-change') {
        const newTheme = event.data.theme;
        const newStyleKey = newTheme === 'dark' ? 'dark' : 'light';
        map.setStyle(styles[newStyleKey]);
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    });

    const map = new mapboxgl.Map({
      container: "map",
      style: styles[initialStyleKey],
      center: [5.0, 50.0], // Europe Mainland
      zoom: 4,
      pitch: 0,
      bearing: 0
    });

    // Standard-Controls
    map.addControl(new mapboxgl.NavigationControl(), "top-left");
    map.addControl(new mapboxgl.FullscreenControl(), "top-left");
    map.addControl(new mapboxgl.ScaleControl({ unit: "metric" }), "bottom-left");

    // Globaler Speicher für die GeoJSON-Daten
    let tripsData = null;

    // Funktion zum Hinzufügen der Custom Layers (wird beim Start und nach Style-Wechsel aufgerufen)
    function addCustomLayers() {
      // Safety check: Style must be loaded to add layers
      if (!map.getStyle()) return;



      // 2. Trips GeoJSON Source & Layer
      if (tripsData) {
        if (!map.getSource("trips")) {
          map.addSource("trips", { type: "geojson", data: tripsData });
        }
        if (!map.getLayer("trips-lines")) {
          map.addLayer({
            id: "trips-lines",
            type: "line",
            source: "trips",
            layout: { "line-cap": "round", "line-join": "round" },
            paint: {
              "line-color": [
                "match", ["get", "category"],
                "nationalExpress", "#0073ff",
                "national", "#00eeff",
                "regional", "#a6026c",
                "suburban", "#fc0000",
                "subway", "#F69A00",
                "tram", "#2FC5CC",
                "bus", "#238443",
                "ferry", "#800",
                "#333333"
              ],
              "line-width": ["interpolate", ["linear"], ["zoom"], 6, 2.5, 14, 8],
              "line-opacity": 0.95
            }
          });
          updateTripFilter(); // Apply current filter
        }
      }
    }

    // Configure Map Layers: Hide roads, filter labels (Show only Countries & Capitals)
    const configureMapLayers = () => {
      const style = map.getStyle();
      if (!style || !style.layers) return;

      for (const layer of style.layers) {
        const id = layer.id || "";
        const srcLayer = layer["source-layer"] || "";
        const filterText = JSON.stringify(layer.filter || "");

        // --- 1. Road & Boundary Hiding (Stricter Logic) ---
        // Hide ALL roads, bridges, tunnels unless they are explicitly rail-related
        const isRoadishId = id.startsWith("road-") || id.startsWith("bridge-") || id.startsWith("tunnel-") || id === "road-label";
        // ONLY keep if ID explicitly mentions rail types. Ignore filter-text as it can be misleading.
        const isRailRelated = /\b(rail|tram|subway|light_rail)\b/i.test(id);

        // administrative boundaries
        const isAdminSource = srcLayer === "admin";
        const isBoundaryId = /boundary/i.test(id);
        const adminLevelIdMatch = /(^|-)admin-(0|1)(-|$)/i.test(id);
        const adminLevelFilter01 = /admin\s*[_-]?level\W*(0|1)/i.test(filterText);
        const adminKeyword = /\b(country|state|province|admin-0|admin-1)\b/i.test(id);

        const isAdmin01Boundary = (isBoundaryId && (adminLevelIdMatch || adminLevelFilter01 || adminKeyword)) ||
          (isAdminSource && (adminLevelFilter01 || adminKeyword));

        // Hide:
        // 1. Roads that are NOT rail related
        // 2. Admin boundaries that are NOT level 0/1 (Conceptually we want to show countries, but hide others. The logic below HIDES if it meets criteria. Wait, original logic was: "if ((road && !rail) || (adminBoundary)) { hide }". actually the original logic HIDERED admin-0/1 if they were NOT symbol.
        // Let's look closer at original: `(isAdmin01Boundary && layer.type !== "symbol")` -> This HIDES country lines? 
        // User said: "only show country names and Capical Names". Usually users want country BORDERS too. Use your judgment: usually borders are good.
        // However, the prompt specifically asked to "Hide the Citynames... and only show country names...". It didn't mention borders.
        // But preventing regression: The previous code HID `isAdmin01Boundary`. I will maintain that behavior for now unless it looks wrong. 
        // Update: The previous code `isAdmin01Boundary` logic seems to be identifying Country/State boundaries. If I hide them, I have no borders.
        // Let's re-read the code I am replacing. 
        // `if (((isRoadishId || isRoadSource) && !isRailRelated) || (isAdmin01Boundary && layer.type !== "symbol"))`
        // Yes, it was hiding Admin-0/1 lines. Maybe the user *wants* a clean map without borders? 
        // Logic: "only show country NAMES". 
        // I will stick to the previous behavior regarding borders to minimize regression, but FIX the road hiding.

        if ((isRoadishId && !isRailRelated) || (isAdmin01Boundary && layer.type !== "symbol")) {
          try {
            if (map.getLayer(id)) {
              map.setLayoutProperty(id, "visibility", "none");
            }
          } catch (_) { /* ignore */ }
        }

        // --- 2. Label Customization (Show only Countries & Capitals) ---
        if (layer.type === "symbol") {
          // A. Country Labels: Ensure Visible
          if (id.includes("country-label")) {
            map.setLayoutProperty(id, "visibility", "visible");
          }
          // B. Settlement Labels: Show ONLY Capitals (capital == 2)
          else if (id.includes("settlement-") || id.includes("place-city") || id.includes("place-town") || id.includes("place-village")) {
            try {
              // Apply filter to only show national capitals (capital == 2)
              map.setFilter(id, ["==", ["get", "capital"], 2]);
              map.setLayoutProperty(id, "visibility", "visible");
            } catch (e) {
              console.warn("Could not set filter on", id, e);
            }
          }
          // C. Hide other distracting labels (States, POIs, etc.)
          else {
            const isCountry = id.includes("country-label");
            // Hide State labels, POIs, etc.
            if (!isCountry && (id.includes("state-label") || id.includes("poi-label") || id.includes("water-point-label") || id.includes("natural-point-label"))) {
              map.setLayoutProperty(id, "visibility", "none");
            }
          }
        }
      }
    };

    // Event: Style fertig geladen (initial oder nach Wechsel)
    map.on("style.load", () => {
      configureMapLayers();
      addCustomLayers();
    });

    // Ensure we try to add layers once the map is fully loaded initially as well
    map.on("load", () => {
      addCustomLayers();
    });

    //GEOjson daten kombinieren in https://geojson.io
    //GEOjson daten generieren in https://brouter.de/brouter-web
    //GEOjson daten strippen in https://mapshaper.org/ command: -filter-fields


    // Daten einmalig laden
    const sources = [
      ["nationalExpress", "assets/geojson/nationalExpress.geojson"],
      ["national", "assets/geojson/national.geojson"],
      ["regional", "assets/geojson/regional.geojson"],
      ["suburban", "assets/geojson/suburban.geojson"],
      ["subway", "assets/geojson/subway.geojson"],
      ["tram", "assets/geojson/tram.geojson"],
      ["bus", "assets/geojson/bus-stripped.geojson"],
      ["ferry", "assets/geojson/ferry.geojson"]
    ];

    Promise.all(sources.map(async ([cat, url]) => {
      const r = await fetch(url);
      const j = await r.json();
      j.features.forEach((f, i) => {
        f.properties = { category: cat, ...(f.properties || {}) };
        if (!f.properties.id) f.properties.id = `${cat}-${i}`;
      });
      return j.features;
    }))
      .then(all => {
        tripsData = { type: "FeatureCollection", features: all.flat() };

        // Try to add layers immediately if style is ready
        addCustomLayers();

        // auf Bounds zoomen (deaktiviert, damit Startansicht bleibt)
        /*
        const bounds = new mapboxgl.LngLatBounds();
        tripsData.features.forEach(f => {
          if (f.geometry?.type === "LineString") {
            f.geometry.coordinates.forEach(c => bounds.extend(c));
          }
        });
        if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 24, maxZoom: 7 });
        */
      })
      .catch(e => console.warn("Fehler beim Laden der externen GeoJSONs:", e));

    // Filter Logic
    function updateTripFilter() {
      if (!map.getLayer("trips-lines")) return;

      const selectedCategories = [];
      document.querySelectorAll('.filter-cb:checked').forEach(cb => {
        const vals = cb.value.split(','); // Split the value by comma to get multiple categories 
        selectedCategories.push(...vals); // Add all values to the array              
      });

      if (selectedCategories.length === 0) {
        // Hide all if nothing selected
        map.setFilter("trips-lines", ["in", "category", ""]);
      } else {
        map.setFilter("trips-lines", ["in", "category", ...selectedCategories]);
      }
    }

    // UI Event Listeners


    // 2. Category Filter
    document.querySelectorAll('.filter-cb').forEach(cb => {
      cb.addEventListener('change', updateTripFilter);
    });
  </script>
</body>

</html>