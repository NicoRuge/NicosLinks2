<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Meine Bahnstrecken Karte</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- External CSS -->
  <link rel="stylesheet" href="css/railmap.css">
</head>

<body>
  <div id="map"></div>

  <a class="home-btn" href="index.html" role="button">Home</a>

  <div class="panel" id="ui">
    <div class="section">
      <h3>Means of Transportation <span class="toggle-icon">â–¼</span></h3>
      <div class="collapsible-content">
        <div class="row"><span class="legend-color" style="background:#ff0000"></span> <label><input type="checkbox"
              class="filter-cb" value="nationalExpress" checked>National
            Express</label> </div>
        <div class="row"><span class="legend-color" style="background:#ff8c00"></span> <label><input type="checkbox"
              class="filter-cb" value="regional" checked>Regional
            Express</label> </div>
        <div class="row"><span class="legend-color" style="background:#ffff00"></span> <label><input type="checkbox"
              class="filter-cb" value="suburban" checked> Suburban</label>
        </div>
        <div class="row"><span class="legend-color" style="background:#1eff00"></span> <label><input type="checkbox"
              class="filter-cb" value="subway" unchecked> Subway</label> </div>
        <div class="row"><span class="legend-color" style="background:#1100ff"></span> <label><input type="checkbox"
              class="filter-cb" value="tram" unchecked> Tram</label> </div>
        <div class="row"><span class="legend-color" style="background:#ff00fb"></span> <label><input type="checkbox"
              class="filter-cb" value="bus" checked> Bus</label> </div>
        <div class="row"><span class="legend-color" style="background:#9500ff"></span> <label><input type="checkbox"
              class="filter-cb" value="ferry" unchecked> Ferry</label> </div>
        <div class="row"><span class="legend-icon">ðŸ“·</span> <label><input type="checkbox" class="layer-toggle"
              data-layer="sights" checked> Sights (Besucht)</label> </div>
      </div>
    </div>
  </div>

  <script>
    // Eigener Mapbox Token hier eintragen
    mapboxgl.accessToken = "pk.eyJ1Ijoibmljb3J1Z2UiLCJhIjoiY21nODVoZ2R2MDNqOTJqczg3c3F4cmZ3MiJ9.1fgkuGwAxjLf26gtzgOm0w";

    // Karte initialisieren (Style je nach gewÃ¤hltem Theme aus index.html)
    const savedTheme = (localStorage.getItem('theme') || 'dark');
    try { document.documentElement.setAttribute('data-theme', savedTheme); } catch (_) { }

    const styles = {
      dark: 'mapbox://styles/mapbox/dark-v11',
      light: 'mapbox://styles/mapbox/streets-v12',
      satellite: 'mapbox://styles/mapbox/satellite-streets-v12'
    };

    // Set initial style based on saved theme or default to dark
    const initialStyleKey = savedTheme === 'dark' ? 'dark' : 'light';

    // Listen for theme changes from parent
    window.addEventListener('message', (event) => {
      if (event.data.type === 'theme-change') {
        const newTheme = event.data.theme;
        const newStyleKey = newTheme === 'dark' ? 'dark' : 'light';
        map.setStyle(styles[newStyleKey]);
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      }
    });

    const map = new mapboxgl.Map({
      container: "map",
      style: styles[initialStyleKey],
      center: [5.0, 50.0], // Europe Mainland
      zoom: 4,
      pitch: 0,
      bearing: 0
    });

    // Standard-Controls
    map.addControl(new mapboxgl.NavigationControl(), "top-left");
    map.addControl(new mapboxgl.FullscreenControl(), "top-left");
    map.addControl(new mapboxgl.ScaleControl({ unit: "metric" }), "bottom-left");

    // Globaler Speicher fÃ¼r die GeoJSON-Daten
    let tripsData = null;

    // Funktion zum HinzufÃ¼gen der Custom Layers (wird beim Start und nach Style-Wechsel aufgerufen)
    function addCustomLayers() {
      // Safety check: Style must be loaded to add layers
      if (!map.getStyle()) return;



      // 2. Trips GeoJSON Source & Layer
      if (tripsData) {
        if (!map.getSource("trips")) {
          map.addSource("trips", { type: "geojson", data: tripsData });
        }
        if (!map.getLayer("trips-lines")) {
          map.addLayer({
            id: "trips-lines",
            type: "line",
            source: "trips",
            layout: { "line-cap": "round", "line-join": "round" },
            paint: {
              "line-color": [
                "match", ["get", "category"],
                "nationalExpress", "#ff0000",
                "national", "#ff9900",
                "regional", "#f6ff00",
                "suburban", "#fc0000",
                "subway", "#F69A00",
                "tram", "#00ff11",
                "bus", "#ff00fb",
                "ferry", "#800",
                "#333333"
              ],
              "line-width": ["interpolate", ["linear"], ["zoom"], 6, 2.5, 14, 8],
              "line-opacity": 0.95
            }
          });
          updateTripFilter(); // Apply current filter
        }
      }

      // 3. Sights Source & Layer
      if (!map.getSource("sights")) {
        map.addSource("sights", {
          type: "geojson",
          data: "assets/geojson/sights.geojson"
        });
      }
      if (!map.getLayer("sights-layer")) {
        map.addLayer({
          id: "sights-layer",
          type: "circle",
          source: "sights",
          paint: {
            "circle-radius": 6,
            "circle-color": "#ff8c00",
            "circle-stroke-width": 2,
            "circle-stroke-color": "#ffffff"
          }
        });

        // Ensure toggle state matches layer visibility
        const toggle = document.querySelector('.layer-toggle[data-layer="sights"]');
        if (toggle) {
          const isVisible = toggle.checked;
          map.setLayoutProperty("sights-layer", "visibility", isVisible ? "visible" : "none");
        }
      }
    }

    // Configure Map Layers: Hide roads, filter labels (Show only Countries & Capitals)
    const configureMapLayers = () => {
      const style = map.getStyle();
      if (!style || !style.layers) return;

      for (const layer of style.layers) {
        const id = layer.id || "";
        const srcLayer = layer["source-layer"] || "";
        const filterText = JSON.stringify(layer.filter || "");

        // --- 1. Road & Boundary Hiding (Stricter Logic) ---
        // Hide ALL roads, bridges, tunnels unless they are explicitly rail-related
        const isRoadishId = id.startsWith("road-") || id.startsWith("bridge-") || id.startsWith("tunnel-") || id === "road-label";
        // ONLY keep if ID explicitly mentions rail types. Ignore filter-text as it can be misleading.
        const isRailRelated = /\b(rail|tram|subway|light_rail)\b/i.test(id);

        // administrative boundaries
        const isAdminSource = srcLayer === "admin";
        const isBoundaryId = /boundary/i.test(id);
        const adminLevelIdMatch = /(^|-)admin-(0|1)(-|$)/i.test(id);
        const adminLevelFilter01 = /admin\s*[_-]?level\W*(0|1)/i.test(filterText);
        const adminKeyword = /\b(country|state|province|admin-0|admin-1)\b/i.test(id);

        const isAdmin01Boundary = (isBoundaryId && (adminLevelIdMatch || adminLevelFilter01 || adminKeyword)) ||
          (isAdminSource && (adminLevelFilter01 || adminKeyword));

        if ((isRoadishId && !isRailRelated) || (isAdmin01Boundary && layer.type !== "symbol")) {
          try {
            if (map.getLayer(id)) {
              map.setLayoutProperty(id, "visibility", "none");
            }
          } catch (_) { /* ignore */ }
        }

        // --- 2. Label Customization (Show only Countries & Capitals) ---
        if (layer.type === "symbol") {
          // A. Country Labels: Ensure Visible
          if (id.includes("country-label")) {
            map.setLayoutProperty(id, "visibility", "visible");
          }
          // B. Settlement Labels: Show ONLY Capitals (capital == 2)
          else if (id.includes("settlement-") || id.includes("place-city") || id.includes("place-town") || id.includes("place-village")) {
            try {
              // Apply filter to only show national capitals (capital == 2)
              map.setFilter(id, ["==", ["get", "capital"], 2]);
              map.setLayoutProperty(id, "visibility", "visible");
            } catch (e) {
              console.warn("Could not set filter on", id, e);
            }
          }
          // C. Hide other distracting labels (States, POIs, etc.)
          else {
            const isCountry = id.includes("country-label");
            // Hide State labels, POIs, etc.
            if (!isCountry && (id.includes("state-label") || id.includes("poi-label") || id.includes("water-point-label") || id.includes("natural-point-label"))) {
              map.setLayoutProperty(id, "visibility", "none");
            }
          }
        }
      }
    };

    // Event: Style fertig geladen (initial oder nach Wechsel)
    map.on("style.load", () => {
      configureMapLayers();
      addCustomLayers();
    });

    // Ensure we try to add layers once the map is fully loaded initially as well
    map.on("load", () => {
      addCustomLayers();
    });

    //GEOjson daten kombinieren in https://geojson.io
    //GEOjson daten generieren in https://brouter.de/brouter-web
    //GEOjson daten strippen in https://mapshaper.org/ command: -filter-fields
    //GPX Editor https://gpx.studio


    // Daten einmalig laden
    const sources = [
      ["nationalExpress", "assets/geojson/nationalExpress_Simplified.geojson"],
      ["national", "assets/geojson/national.geojson"],
      ["regional", "assets/geojson/regional.geojson"],
      ["suburban", "assets/geojson/suburban.geojson"],
      ["subway", "assets/geojson/subway.geojson"],
      ["tram", "assets/geojson/tram.geojson"],
      ["bus", "assets/geojson/bus-stripped.geojson"],
      ["ferry", "assets/geojson/ferry.geojson"]
    ];

    Promise.all(sources.map(async ([cat, url]) => {
      const r = await fetch(url);
      const j = await r.json();
      j.features.forEach((f, i) => {
        f.properties = { category: cat, ...(f.properties || {}) };
        if (!f.properties.id) f.properties.id = `${cat}-${i}`;
      });
      return j.features;
    }))
      .then(all => {
        tripsData = { type: "FeatureCollection", features: all.flat() };

        // Try to add layers immediately if style is ready
        addCustomLayers();

        // auf Bounds zoomen (deaktiviert, damit Startansicht bleibt)
        /*
        const bounds = new mapboxgl.LngLatBounds();
        tripsData.features.forEach(f => {
          if (f.geometry?.type === "LineString") {
            f.geometry.coordinates.forEach(c => bounds.extend(c));
          }
        });
        if (!bounds.isEmpty()) map.fitBounds(bounds, { padding: 24, maxZoom: 7 });
        */
      })
      .catch(e => console.warn("Fehler beim Laden der externen GeoJSONs:", e));

    // Filter Logic
    function updateTripFilter() {
      if (!map.getLayer("trips-lines")) return;

      const selectedCategories = [];
      document.querySelectorAll('.filter-cb:checked').forEach(cb => {
        const vals = cb.value.split(','); // Split the value by comma to get multiple categories 
        selectedCategories.push(...vals); // Add all values to the array              
      });

      if (selectedCategories.length === 0) {
        // Hide all if nothing selected
        map.setFilter("trips-lines", ["in", "category", ""]);
      } else {
        map.setFilter("trips-lines", ["in", "category", ...selectedCategories]);
      }
    }

    // UI Event Listeners


    // 2. Category Filter
    document.querySelectorAll('.filter-cb').forEach(cb => {
      cb.addEventListener('change', updateTripFilter);
    });

    // 2.1 Layer Toggles
    document.querySelectorAll('.layer-toggle').forEach(toggle => {
      toggle.addEventListener('change', (e) => {
        const layerName = e.target.dataset.layer + '-layer';
        const isVisible = e.target.checked;
        if (map.getLayer(layerName)) {
          map.setLayoutProperty(layerName, 'visibility', isVisible ? 'visible' : 'none');
        }
      });
    });
    // 4. Sights Layer Interactions (Popups & Cursor)
    map.on('click', 'sights-layer', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;
      const name = props.name || "Unknown";
      const when = props.when || "";

      // Ensure that if the map is zoomed out such that multiple
      // copies of the feature are visible, the popup appears
      // over the copy being pointed to.
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML(`<strong>${name}</strong><br>${when}`)
        .addTo(map);
    });

    map.on('mouseenter', 'sights-layer', () => {
      map.getCanvas().style.cursor = 'pointer';
    });

    map.on('mouseleave', 'sights-layer', () => {
      map.getCanvas().style.cursor = '';
    });

    // 3. Collapsible Menus
    document.querySelectorAll('.panel h3').forEach(header => {
      header.addEventListener('click', () => {
        const content = header.nextElementSibling;
        content.classList.toggle('collapsed');
        // Toggle icon rotation class on header itself or parent if preferred, 
        // here we toggle on header to target the icon via CSS
        header.classList.toggle('collapsed');
      });
    });
  </script>
</body>

</html>